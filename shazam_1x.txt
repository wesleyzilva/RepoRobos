Input
  StopPts(10.0);        
  AlvoFinal(40.0);      // Aumentamos para 40 para aproveitar a força do 60min
  ParcialPts(12.0);     
  GatilhoBE(7.5);       
  pMediaCurta(20);      
  pMedia15min(60);      // Média de 20 do gráfico de 15min
  pMedia60min(240);     // Média de 20 do gráfico de 1 hora
  pHiLo(4);             
  nLotes(3);

Var
  vMME20, vMME60, vMME240 : Float;
  vHiLo                   : Float;
  vLucroAtual             : Float;
  vCorpoCandle            : Float;
  vRangeTotal             : Float;
  vUltimaBarra            : Integer;

Begin
  // 1. Indicadores de Tripla Confirmação (5m, 15m e 1h)
  vMME20   := MediaExp(pMediaCurta, Close);
  vMME60   := MediaExp(pMedia15min, Close); 
  vMME240  := MediaExp(pMedia60min, Close); // O filtro de 1 hora
  vHiLo    := HiloActivator(pHiLo);
  
  vCorpoCandle := Close - Open;      
  vRangeTotal  := High - Low;        

  // 2. REGRA DE OURO (Aguardar 1 candle de 5min conforme sua instrução)
  if (BuyPosition = 0) and (CurrentBar > (vUltimaBarra + 1)) then
  begin
    
    // 3. LÓGICA DE ENTRADA INSTITUCIONAL
    if (Time >= 0910) and (Time < 1150) then
    begin
      // SÓ COMPRA SE: 5min > 15min > 60min (Alinhamento Total)
      // Adicionamos a condição: Close > vMME240
      if (Close > vMME20) and (Close > vMME60) and (Close > vMME240) 
         and (Close > vHiLo) and (vCorpoCandle > (vRangeTotal * 0.60)) then 
      begin
        BuyAtMarket(nLotes); 
      end;
    end;
  end;

  // 4. GESTÃO DE SAÍDA (Aproveitando a tendência longa do 60min)
  if (BuyPosition > 0) then
  begin
    vLucroAtual := Close - BuyPrice;

    SellToCoverStop(BuyPrice - StopPts, BuyPrice - StopPts, BuyPosition);
    SellToCoverLimit(BuyPrice + AlvoFinal, BuyPosition);

    if (BuyPosition = nLotes) then
       SellToCoverLimit(BuyPrice + ParcialPts, 2);

    if (vLucroAtual >= GatilhoBE) and (BuyPosition = nLotes) then
       SellToCoverStop(BuyPrice + 1.5, BuyPrice + 1.5, BuyPosition);

    // Trailing Stop mais "largo" para não sair de tendências do 60min
    if (BuyPosition < nLotes) then 
    begin
       if (vLucroAtual >= 25.0) then
          SellToCoverStop(BuyPrice + 18.0, BuyPrice + 18.0, BuyPosition)
       else if (vLucroAtual >= 15.0) then
          SellToCoverStop(BuyPrice + 8.0, BuyPrice + 8.0, BuyPosition);
       
       if (Close < vHiLo) then ClosePosition;
    end;
    
    vUltimaBarra := CurrentBar;
  end;

  if (Time >= 1300) then ClosePosition;
End;