var
  // Definição de Cores Personalizadas
  cCinza, cVerde, cVermelho, cAmarelo, cFuchsia, cCiano, cAzulRoyal, cMarrom : Integer;

  fCorpo, fPavioSup, fPavioInf, fRange : float;
  fCorpoAnt, fPavioSupAnt, fPavioInfAnt, fRangeAnt : float;
  fOpen1, fClose1, fHigh1, fLow1, fOpen2, fClose2, fHigh2, fLow2 : float;
  fCorpo1, fRange1, fPavioSup1, fPavioInf1 : float;
  fMedia20_1, fMedia20_2 : float;
  vOBV1, vOBV2 : float;
  bAlta, bBaixa : boolean;
  fMedia20 : float;
  vOBV : float;
  bFluxoComprador, bFluxoVendedor : boolean;
  bTendenciaAlta, bTendenciaBaixa, bAnteriorDeAlta, bAnteriorDeBaixa : boolean;
  bDoisAtrasAlta, bDoisAtrasBaixa : boolean;
  bAntMartelo, bAntEstrela, bReversaoCompraConfirmada, bReversaoVendaConfirmada : boolean;
  bGoldSignalCompra, bGoldSignalVenda : boolean;
  bGoldContinuacaoCompra, bGoldContinuacaoVenda : boolean;

begin
  // Inicialização das Cores
  cCinza      := RGB(105, 105, 105);
  cVerde      := RGB(0, 255, 0);
  cVermelho   := RGB(255, 0, 0);
  cAmarelo    := RGB(255, 255, 0);
  cFuchsia    := RGB(255, 0, 255);
  cCiano      := RGB(0, 255, 255);
  cAzulRoyal  := RGB(65, 105, 225);
  cMarrom     := RGB(165, 42, 42);

  // 1. Cálculos Básicos do Candle
  fRange := Range;
  fCorpo := Abs(Close - Open);
  
  if (Close >= Open) then
    begin
      fPavioSup := High - Close;
      fPavioInf := Open - Low;
      bAlta := True;
      bBaixa := False;
    end
  else
    begin
      fPavioSup := High - Open;
      fPavioInf := Close - Low;
      bAlta := False;
      bBaixa := True;
    end;

  // 1.1 Filtro de Fluxo (OBV Puro)
  vOBV := OBV;
  bFluxoComprador := (vOBV > vOBV[1]);
  bFluxoVendedor  := (vOBV < vOBV[1]);

  // Contexto de Tendência (para o Gold Signal)
  fMedia20 := MediaExp(20, Close);
  bTendenciaAlta := (Close > fMedia20) and (fMedia20 > fMedia20[1]);
  bTendenciaBaixa := (Close < fMedia20) and (fMedia20 < fMedia20[1]);

  // Contexto do candle anterior para o Gold Signal (Sua nova condição)
  bAnteriorDeAlta := Close[1] > Open[1];   // Candle anterior foi de compra
  bAnteriorDeBaixa := Close[1] < Open[1];  // Candle anterior foi de venda
  bDoisAtrasAlta := Close[2] > Open[2];
  bDoisAtrasBaixa := Close[2] < Open[2];

  // Pré-cálculos de séries para evitar acessos posicionais dentro de condicionais
  fOpen1 := Open[1];
  fClose1 := Close[1];
  fHigh1 := High[1];
  fLow1 := Low[1];
  fOpen2 := Open[2];
  fClose2 := Close[2];
  fHigh2 := High[2];
  fLow2 := Low[2];

  fRange1 := Range[1];
  fCorpo1 := Abs(fClose1 - fOpen1);

  if (fClose1 >= fOpen1) then
  begin
    fPavioSup1 := fHigh1 - fClose1;
    fPavioInf1 := fOpen1 - fLow1;
  end
  else
  begin
    fPavioSup1 := fHigh1 - fOpen1;
    fPavioInf1 := fClose1 - fLow1;
  end;

  fMedia20_1 := MediaExp(20, Close[1]);
  fMedia20_2 := MediaExp(20, Close[2]);
  vOBV1 := OBV[1];
  vOBV2 := OBV[2];

  bGoldContinuacaoCompra := (fClose1 >= fOpen1) and (fClose1 > fMedia20_1) and (fMedia20_1 > fMedia20_2) and (fCorpo1 >= (fRange1 * 0.70)) and (fClose1 > fHigh2) and (fClose2 > fOpen2) and (fPavioSup1 <= (fRange1 * 0.20)) and (vOBV1 > vOBV2);
  bGoldContinuacaoVenda := (fClose1 < fOpen1) and (fClose1 < fMedia20_1) and (fMedia20_1 < fMedia20_2) and (fCorpo1 >= (fRange1 * 0.70)) and (fClose1 < fLow2) and (fClose2 < fOpen2) and (fPavioInf1 <= (fRange1 * 0.20)) and (vOBV1 < vOBV2);

  // Reversão confirmada: contexto anterior [2] + candle de reversão [1] + confirmação no candle atual
  fRangeAnt := fHigh1 - fLow1;
  fCorpoAnt := Abs(fClose1 - fOpen1);

  if (fClose1 >= fOpen1) then
  begin
    fPavioSupAnt := fHigh1 - fClose1;
    fPavioInfAnt := fOpen1 - fLow1;
  end
  else
  begin
    fPavioSupAnt := fHigh1 - fOpen1;
    fPavioInfAnt := fClose1 - fLow1;
  end;

  bAntMartelo := (fRangeAnt > 0) and (fPavioInfAnt > (fCorpoAnt * 2)) and (fPavioSupAnt < fCorpoAnt);
  bAntEstrela := (fRangeAnt > 0) and (fPavioSupAnt > (fCorpoAnt * 2)) and (fPavioInfAnt < fCorpoAnt);

  bReversaoCompraConfirmada := bAntMartelo and bDoisAtrasBaixa and (fLow1 <= fLow2) and bFluxoComprador and (Close > fHigh1);
  bReversaoVendaConfirmada := bAntEstrela and bDoisAtrasAlta and (fHigh1 >= fHigh2) and bFluxoVendedor and (Close < fLow1);

  // 2. Lógica de Coloração (Hierarquia de Prioridade)
  
  // Default: Cinza (Mercado sem tendência / Ruído)
  PaintBar(cCinza);

  // Cálculo dos Sinais Gold (Atual)
  bGoldSignalCompra := bAlta and bTendenciaAlta and (fCorpo >= (fRange * 0.70)) and (Close > High[1]) and bAnteriorDeAlta and (fPavioSup <= (fRange * 0.20)) and bFluxoComprador;
  bGoldSignalVenda := bBaixa and bTendenciaBaixa and (fCorpo >= (fRange * 0.70)) and (Close < Low[1]) and bAnteriorDeBaixa and (fPavioInf <= (fRange * 0.20)) and bFluxoVendedor;

  // Prioridade 1: Gold Signal (Amarelo) - Mais de 4 confluências
  if bGoldSignalCompra then
  begin
    PaintBar(cAmarelo); // Gold Signal Compra
    Alert(cAmarelo);
  end
  else if bGoldSignalVenda then
  begin
    PaintBar(cAmarelo); // Gold Signal Venda
    Alert(cAmarelo);
  end

  // Prioridade 1.1: Continuidade do Gold Signal (Candle Seguinte)
  // Se o candle anterior foi Gold, o atual pinta de Verde/Vermelho para confirmar direção
  else if bGoldContinuacaoCompra then
    PaintBar(cVerde)
  else if bGoldContinuacaoVenda then
    PaintBar(cVermelho)

  // Prioridade 3: Reversão confirmada (anterior + posterior)
  else if bReversaoVendaConfirmada then
    PaintBar(cAzulRoyal) // Estrela Cadente confirmada
  else if bReversaoCompraConfirmada then
    PaintBar(cMarrom) // Martelo confirmado

  // Prioridade 4: Padrões Técnicos (Verde/Vermelho)
  else if (Close > Open) and (Close > High[1]) and (Open < Low[1]) and bFluxoComprador then
    PaintBar(cVerde) // Engolfo de Alta
  else if (Close < Open) and (Close < Low[1]) and (Open > High[1]) and bFluxoVendedor then
    PaintBar(cVermelho) // Engolfo de Baixa

  // Prioridade 2: Força / Momentum (Ciano / Fuchsia)
  else if (fCorpo >= (fRange * 0.70)) and bAlta and (fPavioSup <= (fRange * 0.20)) and bFluxoComprador then
    PaintBar(cCiano) // Barra de Força Compra
  else if (fCorpo >= (fRange * 0.70)) and bBaixa and (fPavioInf <= (fRange * 0.20)) and bFluxoVendedor then
    PaintBar(cFuchsia); // Barra de Força Venda

  // Classificação do primeiro candle do dia por Price Action + tipo de candle
  // Regra: rejeição forte prevalece sobre a cor do corpo.
  if (Date <> Date[1]) then
  begin
    // Rejeição vendedora forte (pavio superior dominante): sinal de venda
    if (fPavioSup >= (fCorpo * 1.5)) and (fPavioSup > fPavioInf) then
      PaintBar(cVermelho)

    // Rejeição compradora forte (pavio inferior dominante): sinal de compra
    else if (fPavioInf >= (fCorpo * 1.5)) and (fPavioInf > fPavioSup) then
      PaintBar(cVerde)

    // Sem rejeição clara: segue direção do fechamento
    else if (Close >= Open) then
      PaintBar(cVerde)
    else
      PaintBar(cVermelho);
  end;

end;