Input
  nLotes(3);
  StopPts(6.0);   
  AlvoPts(13.0);         // Ajuste fino para elevar o PF para > 1,8
  GatilhoBreakeven(7.5); // Proteção precoce
  PeriodoIFR(2);
  HoraFim(1700);

Var
  vIFR, vVWAP : Float;
  vResultadoHoje : Float;
  bJanelaSujeira : Boolean;
  vPrecoEntrada, vSG, vSL : Float;
  vUltimaBarraSair : Integer;
  vAmplitudeCandle : Float;

Begin
  // 1. PERFORMANCE E SEGURANÇA
  vResultadoHoje := DailyResult;
  vVWAP := VWAP(1);
  vIFR  := RSI(PeriodoIFR, 1);
  vAmplitudeCandle := High - Low;

  // 2. FILTRO DE HORÁRIO E METAS (Preservar o PF)
  bJanelaSujeira := (Time < 1010) or (Time >= HoraFim) or 
                    (vResultadoHoje >= (26.0 * nLotes * 10)) or // Para com 2 Gains
                    (vResultadoHoje <= -(12.0 * nLotes * 10)); // Para com 2 Losses

  // 3. GATILHO DE ENTRADA (MÍNIMA/MÁXIMA + FILTRO DE AMPLITUDE)
  if (BuyPosition = 0) and (SellPosition = 0) and (Not bJanelaSujeira) then
  begin
    // Filtro: O candle não pode ser gigantesco (evita entrar no meio de notícias)
    if (vAmplitudeCandle < 10.0) then 
    begin
      // COMPRA: IFR em Pânico + Rompimento da Máxima
      if (vIFR < 15) and (Close < vVWAP) then 
      begin
        PaintBar(clLime);
        BuyStop(High + MinPriceIncrement, High + 0.5); 
      end;

      // VENDA: IFR em Euforia + Rompimento da Mínima
      if (vIFR > 85) and (Close > vVWAP) then 
      begin
        PaintBar(clRed);
        SellShortStop(Low - MinPriceIncrement, Low - 0.5);
      end;
    end;
  end;

  // 4. GESTÃO DE SAÍDA (Tradução Visual de Cores)
  if (BuyPosition > 0) then
  begin
    vPrecoEntrada := BuyPrice;
    vSG := vPrecoEntrada + AlvoPts;
    
    // Breakeven: Se andar 7.5 pts, protege com 0.5 de lucro
    if (Close - vPrecoEntrada >= GatilhoBreakeven) then vSL := vPrecoEntrada + 0.5
    else vSL := vPrecoEntrada - StopPts;
    
    Plot(vSG); SetPlotColor(1, clTeal);    // GAIN: VERDE ÁGUA
    Plot2(vSL); SetPlotColor(2, clYellow); // LOSS: AMARELO
    SellToCoverLimit(vSG); SellToCoverStop(vSL, vSL);
  end
  else if (SellPosition > 0) then
  begin
    vPrecoEntrada := SellPrice;
    vSG := vPrecoEntrada - AlvoPts;
    
    if (vPrecoEntrada - Close >= GatilhoBreakeven) then vSL := vPrecoEntrada - 0.5
    else vSL := vPrecoEntrada + StopPts;
    
    Plot(vSG); SetPlotColor(1, 12615935); // GAIN: VERMELHO CLARO
    Plot2(vSL); SetPlotColor(2, clMaroon); // LOSS: VERMELHO ESCURO
    BuyToCoverLimit(vSG); BuyToCoverStop(vSL, vSL);
  end;

  SetPlotWidth(1, 4); SetPlotWidth(2, 4);
End;