Input
  StopPts(9.5);         // O "ponto doce" para evitar violinos no 5m
  AlvoPts(30.0);        // Alvo institucional para surfar o fator do 60m
  BreakevenPts(9.0);    
  QtdeContratos(5);     
  LookbackPeriodo(24);  // Range de 2 horas para um Fibo mais forte
  pMedia(20);

Var
  vFibo618       : Float;
  vMaxH2, vMinH2 : Float;
  vMME20         : Float;
  vUltimaBarra   : Integer;

Begin
  // 1. Cálculo do Panorama de 2 Horas
  vMaxH2 := Highest(High, LookbackPeriodo); 
  vMinH2 := Lowest(Low, LookbackPeriodo);   
  vMME20 := MediaExp(pMedia, Close);
  
  // Nível de Retração 61.8%
  vFibo618 := vMaxH2 - ((vMaxH2 - vMinH2) * 0.618);

  // 2. Visualização do Nível no Gráfico
  Plot(vFibo618);
  SetPlotColor(1, RGB(255,215,0)); // Cor Ouro

  // 3. REGRA DE OURO (Sua instrução: Aguardar 1 candle de 5min após saída)
  if (BuyPosition = 0) and (CurrentBar > (vUltimaBarra + 1)) then
  begin
    
    // 4. GATILHO DE ENTRADA (Confirmação por Rompimento)
    if (Time >= 0915) and (Time < 1500) then
    begin
      // Tocou a linha de Fibo + Preço acima da Média + Candle de Alta (Confirmação)
      if (Low <= vFibo618) and (Close > vMME20) and (Close > Open) then
      begin
         BuyStop(High + 0.5, High + 0.5, QtdeContratos);
      end;
    end;
  end;

  // 5. GESTÃO DE RISCO E SAÍDA
  if (BuyPosition > 0) then
  begin
    // Ordens Automáticas
    SellToCoverLimit(BuyPrice + AlvoPts, QtdeContratos);
    SellToCoverStop(BuyPrice - StopPts, BuyPrice - StopPts, QtdeContratos);

    // Proteção de Lucro (Break-even + 1.5 pts)
    if (Close >= BuyPrice + BreakevenPts) then
    begin
       SellToCoverStop(BuyPrice + 1.5, BuyPrice + 1.5, BuyPosition);
    end;
    
    // REGISTRO DA BARRA DE SAÍDA PARA A REGRA DE ESPERA
    vUltimaBarra := CurrentBar;
  end;

  // Encerramento do dia
  if (Time >= 1550) then ClosePosition;
End;