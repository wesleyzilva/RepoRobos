{
  Indicador: fev_PainelDecisao
  Autor: Wesley (Gemini Code Assist)
  Descrição: Consolida o checklist de 3 etapas (VWAP, Estrutura, OBV)
             do Setup Operacional em um painel visual e sonoro.
}

input
  PeriodoEstrutura(5);
  PeriodoOBV(20);

var
  // --- Variáveis de Validação ---
  bCompraAutorizada, bVendaAutorizada : boolean;

  // --- Variáveis de Cálculo ---
  vVwapDiaria, vVwapSemanal : float;
  maxN, minN : float;
  obv, mediaObv : float;

begin
  // --- 1. PASSO 1: VALIDAÇÃO INSTITUCIONAL (VWAP) ---
  vVwapDiaria  := VWAP(1);
  vVwapSemanal := VWAP(2);

  // --- 2. PASSO 2: VALIDAÇÃO DE ESTRUTURA (PIVÔ) ---
  maxN := Highest(High, PeriodoEstrutura);
  minN := Lowest(Low, PeriodoEstrutura);

  // --- 3. PASSO 3: VALIDAÇÃO DE FLUXO (OBV) ---
  obv := OnBalanceVolume;
  mediaObv := Media(PeriodoOBV, obv);

  // --- 4. DECISÃO FINAL (CONFLUÊNCIA) ---
  bCompraAutorizada := (Close > vVwapDiaria) and (Close > vVwapSemanal) and (Close > maxN[1]) and (obv > mediaObv);
  bVendaAutorizada  := (Close < vVwapDiaria) and (Close < vVwapSemanal) and (Close < minN[1]) and (obv < mediaObv);

  // --- 5. VISUALIZAÇÃO E ALARME ---
  if bCompraAutorizada then
  begin
    PlotText('COMPRA AUTORIZADA', RGB(0, 255, 0), 12, 0, High * 1.01);
    if not bCompraAutorizada[1] then PlaySound('Ring.wav');
  end
  else if bVendaAutorizada then
  begin
    PlotText('VENDA AUTORIZADA', RGB(255, 0, 0), 12, 0, High * 1.01);
    if not bVendaAutorizada[1] then PlaySound('Ring.wav');
  end
  else
    PlotText('AGUARDANDO CONFLUÊNCIA...', RGB(255, 255, 0), 10, 0, High * 1.01);
end;