{
  Estratégia: fev_VSAassinaturaInstitucional
  Autor: Wesley
  Descrição: Regra de Coloração que identifica sinais de VSA (Volume Spread Analysis). 
             Pinta Shakeouts (sinal de força) e Upthrusts (sinal de fraqueza).
}

Input
  volMultiplier(1.5); // Volume Alto (Sinal Padrão). Padrão: 1.5x a média
  volGold(2.0);       // Volume Ultra Alto (Sinal Ouro). Padrão: 2.0x a média
  volPeriod(20);      // Período da média para o volume. Padrão: 20

Var
  avgVolume     : Real;
  spread        : Real;
  closePosition : Real;
  corShakeout   : Integer;
  corUpthrust   : Integer;
  corCyan       : Integer;
  corFuchsia    : Integer;
  corNeutra     : Integer;

begin
  // --- DEFINIÇÃO DE CORES ---
  corShakeout := RGB(0, 255, 0);     // Verde (Sinal de Compra VSA)
  corUpthrust := RGB(255, 0, 0);     // Vermelho (Sinal de Venda VSA)
  corCyan     := RGB(0, 255, 0);     // Verde (Compra Extrema/Clímax)
  corFuchsia  := RGB(255, 0, 0);     // Vermelho (Venda Extrema/Clímax)
  corNeutra   := RGB(105, 105, 105); // Cinza (mercado sem sinal)

  // --- CÁLCULOS ---
  // 1. Média Móvel Simples do Volume (Quantity é o volume no NTSL)
  avgVolume := Media(Quantity, volPeriod);

  // 2. Spread (Range) do Candle
  spread := High - Low;

  // 3. Posição do Fechamento (0 = na mínima, 1 = na máxima)
  // Proteção contra divisão por zero em candles sem range (dojis)
  if spread > 0 then
    closePosition := (Close - Low) / spread
  else
    closePosition := 0.5; // Em um doji, o fechamento está no meio

  // --- PINTURA ---
  PaintBar(corNeutra); // Pinta tudo de cinza por padrão

  // Só aplica coloração VSA se NÃO for o primeiro candle do dia
  if (Date = Date[1]) then
  begin
    // 1. Verifica Upthrust (Venda)
    if (closePosition < 0.33) then
    begin
      if (Quantity > avgVolume * volGold) then
        PaintBar(corFuchsia)   // Prioridade 1: Volume Extremo (> 2.0x) = Fúcsia (Venda)
      else if (Quantity > avgVolume * volMultiplier) then
        PaintBar(corUpthrust); // Prioridade 2: Volume Alto (> 1.5x) = Vermelho
    end;

    // 2. Verifica Shakeout/Rejeição (Compra)
    if (closePosition > 0.66) then
    begin
      if (Quantity > avgVolume * volGold) then
        PaintBar(corCyan)      // Prioridade 1: Volume Extremo (> 2.0x) = Ciano (Compra)
      else if (Quantity > avgVolume * volMultiplier) then
        PaintBar(corShakeout); // Prioridade 2: Volume Alto (> 1.5x) = Verde
    end;
  end;

end;
