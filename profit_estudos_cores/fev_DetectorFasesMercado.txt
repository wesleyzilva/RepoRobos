{
  Indicador: fev_DetectorFasesMercado
  Autor: Wesley (Gemini Code Assist)
  Descrição: Identifica as 4 Fases do Mercado (Wyckoff/Dow) baseando-se na
             inclinação da Média de 20 e posição relativa à Média de 200.
}

var
  mme20, mma200 : float;
  inclinacao20 : float;
  faseMercado : string;
  corFundo : integer;
  limiarFlat : float;

begin
  // --- 1. CÁLCULOS ---
  mme20  := MediaExp(20, Close);
  mma200 := Media(200, Close);

  // Calcula a inclinação da média (Diferença entre a média atual e a anterior)
  inclinacao20 := mme20 - mme20[1];

  // Define o que é "Flat" (Lateral). Ajuste conforme o ativo.
  // Para Índice (WIN), 5 a 10 pontos. Para Dólar (WDO), 0.5 a 1 ponto.
  // Aqui usamos um valor genérico proporcional ao preço para funcionar em BITFUT/WSPFUT
  limiarFlat := Close * 0.0002; // 0.02% do preço

  // --- 2. LÓGICA DE DECISÃO ---

  // Cenário A: Tendência Definida (Alta ou Baixa)
  if (Abs(inclinacao20) > limiarFlat) then
    begin
      if (inclinacao20 > 0) and (Close > mme20) then
        begin
          faseMercado := "FASE 2: TENDÊNCIA DE ALTA (Markup)";
          corFundo := RGB(230, 255, 230); // Fundo Verde Claro
        end
      else if (inclinacao20 < 0) and (Close < mme20) then
        begin
          faseMercado := "FASE 4: TENDÊNCIA DE BAIXA (Markdown)";
          corFundo := RGB(255, 230, 230); // Fundo Vermelho Claro
        end
      else
        begin
          // Preço cruzando a média inclinada (Correção complexa)
          faseMercado := "CORREÇÃO / INDEFINIDO";
          corFundo := RGB(240, 240, 240); // Cinza Claro
        end;
    end
  // Cenário B: Lateralidade (Acumulação ou Distribuição)
  else
    begin
      // Se está lateral ACIMA da 200 -> Provável Distribuição ou Reacumulação
      if (Close > mma200) then
        begin
          faseMercado := "FASE 3: DISTRIBUIÇÃO (Lateral de Topo)";
          corFundo := RGB(255, 250, 205); // Amarelo Claro
        end
      // Se está lateral ABAIXO da 200 -> Provável Acumulação
      else
        begin
          faseMercado := "FASE 1: ACUMULAÇÃO (Lateral de Fundo)";
          corFundo := RGB(230, 240, 255); // Azul Claro
        end;
    end;

  // --- 3. VISUALIZAÇÃO ---
  
  // Pinta o candle (SetChartColor não foi reconhecido neste contexto)
  PaintBar(corFundo);

  // Escreve a fase no topo do candle
  PlotText(faseMercado, RGB(255, 255, 255), 8, 0, High * 1.002);
  
  // Plota as médias para referência visual
  Plot(mme20);
  Plot2(mma200);
  
  // Configura as cores das linhas (Usando RGB para evitar erros de constante)
  SetPlotColor(1, RGB(255, 0, 255)); // Fuchsia
  SetPlotWidth(1, 2);
  SetPlotColor(2, RGB(255, 255, 255)); // White
  SetPlotWidth(2, 2);

end;